package com.pizza.model;


import java.sql.Connection;
import java.sql.SQLException;
import java.util.HashMap;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
/*****
 * 
 * @author minesabry
 * Dans cette classe on s'occupe de notre panier
 * on enregistre les pizza qu'il souhaite commander dans un cookie
 *
 */
public class Panier {
	private static Panier instance = null;
	private static HashMap<Integer,PizzaPanier> panier;
	private Connection connexion;
	private String resultat;
	
	private  Panier () {
		panier = new HashMap<>();
	}
	
	public static Panier getInstance () {
		if (instance == null) instance = new Panier();
		return instance;
	}
	//ajouter une pizza dans le panier
	public void ajouterPizzaAuPanier (HttpServletRequest request,HttpServletResponse response) throws ClassNotFoundException, SQLException {
		//on recharge la base de données
		ChargerDatatBase ();
		ListeDesPizzas nosPizzas = new ListeDesPizzas(connexion);
		//on envoie la liste des pizzas à la vue
		nosPizzas.affichePizzas();
		
		request.setAttribute("pizzas", nosPizzas.getPizzas());
		PizzaPanier mapizza = new PizzaPanier (Integer.parseInt(request.getParameter("idPizza")), 
				request.getParameter("nom"), Float.parseFloat(request.getParameter("prix")), 
				request.getParameter("photo"), request.getParameter("taille"),request.getParameter("ingredients"));
		
		//if (Integer.parseInt(request.getParameter("qteStock")) > mapizza.getQte()) {
			
		
		//on vérifie si la pizza est dans le panier : dans ce cas on fait juste mise à jour de la qte et du prix
		if (panier.containsKey(mapizza.getIdPizza())) {
			System.out.println(panier.get(mapizza.getIdPizza()).getQte() +"++++"+Integer.parseInt(request.getParameter("qteStock")));
			System.out.println ("vous avez déjà ajouter cette pizza ");
			if (panier.get(mapizza.getIdPizza()).getQte() < Integer.parseInt(request.getParameter("qteStock")))
				panier.get(mapizza.getIdPizza()).calcul();
			else {
				resultat = "Cette pizza est finie pour l'instant";
				
			}		
		} else {
			mapizza.calcul();
			System.out.println("Vous avez ajouté une pizza");
			panier.put(mapizza.getIdPizza(), mapizza);
		}
		//on envoie le panier à la vue par le biais du controleur
		//on stocke les informations dans un cookie
		request.setAttribute("panier",panier);
		System.out.println("Le panier "+panier);
		
		request.setAttribute("resultat", resultat);
		//}
		
	}
	///Affiche le contenu du panier
	public void affiche () {
		for (Integer k : panier.keySet()) {
			PizzaPanier p =panier.get(k);
			System.out.println(p.toString());
		}
	}
	//charger la base de donnée
	private void ChargerDatatBase () throws ClassNotFoundException, SQLException {
		connexion = ConnexionBDChargeDriver.getInstance().getConnexion();
	}
}
