package com.pizza.model;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import javax.servlet.http.HttpServletRequest;

/**
 * 
 * @author minesabry
 *
 *Cette classe vérifie les données envoyées par le client pour établir une connexion et en fonction de cela un message d'erreur 
 *est édité ou pas
 */
public class ConnexionForm {
	private String resultat;
	//1-se connecter à la base de données mysql
	private Connection connexion;
	
	

	/***
	 * 
	 * @param request
	 * @return true si les identifiants sont bons ce qui nous permettra de savoir s'il faut se rédiriger vers la page du client 
	 * @throws SQLException 
	 * @throws ClassNotFoundException 
	 */
	public boolean verifierIdentifiantsCon (HttpServletRequest request) throws ClassNotFoundException, SQLException {
		
		//on crée une variable de session pour pouvoir garder la connexion de l'utilisateur active tout aut long de la session tant que le navigateur n'est pas fermée
		String mail = request.getParameter("email");
		String mp = request.getParameter("password");
		int id;
		String nom;
		String prenom;
		String email;
		
		Sessions sessions = new Sessions (request,mail,mp);
		
		
		//TDO:
		//1 : appel de la fonction qui charger la base de données
		ChargerDatatBase();
		
		 
		Statement statement = connexion.createStatement();
		ResultSet reponse = statement.executeQuery("SELECT * FROM Personne");
		boolean mailTrouve = false;
		
		while (reponse.next() && mailTrouve != true) {
			id = Integer.parseInt(reponse.getString ("IDPersonne"));
		    nom = reponse.getString ("Nom");
			prenom = reponse.getString ("Prenom");
			email = reponse.getString ("Email");
			if (email.equals(mail)) mailTrouve = true;
			String adresse = reponse.getString ("Adresse");
			System.out.println(nom+" "+prenom+" "+email+" "+adresse);
		}
		//2-véfrifier que le login existe 
		if (mailTrouve != true) {
			resultat = new String ("Ce login n'existe pas");
			return false;
		}
		//3-si oui verifier que le mot de pass est le bon
		
		//4-si le mot de passe fournit diffère de celui enregistré renvoyé 
		String mpBd = "12345";//à changer par le mot de récupérer dans la base
		if (!mp.equals(mpBd)) {
			resultat = new String ("Email ou mot de pass incorrect");
			return false;
		}
		int id = Integer.parseInt(reponse.getString ("IDPersonne"));
		String nom = reponse.getString ("Nom");
		String prenom = reponse.getString ("Prenom");
		String email = reponse.getString ("Email");
		if (email.equals(mail)) mailTrouve = true;
		String adresse = reponse.getString ("Adresse");
		System.out.println(nom+" "+prenom+" "+email+" "+adresse);
		//5-si l'identifiant n'existe dans la base de donées pas alors 
		/****
		 * resultat = new String ("Compte inexistant")
		 * return false;
		 */
		return true;
	}

	public String getResultat() {
		return resultat;
	}

	public void setResultat(String resultat) {
		this.resultat = resultat;
	}
	//Cette fonction fait appel à notre singleton qui charge la dataBase
	private void ChargerDatatBase () throws ClassNotFoundException, SQLException {
		connexion = ConnexionBDChargeDriver.getInstance().getConnexion();
	}
}
